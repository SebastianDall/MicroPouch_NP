---
title: "Ordination plot"
author: "Sebastian MÃ¸lvang Dall"
date: '2022-08-24'
output: html_document
---


## libraries and functions

```{r}
library(tidyverse)
library(ampvis2)
library(RColorBrewer)
library(mplibrary)
source("./R/functions/metadata_functions.R")
source("./R/functions/bioinformatics.R")
source("./R/functions/gg_functions.R")
```


## Load data

```{r}
metadata <- load_metadata()

metaphlan <- load_metaphlan("fulltax_species")

project_filter <- "NP"
```



## NP and MP donor PCA

```{r}
metadata_NP <- metadata %>%
  filter(LibID %in% colnames(metaphlan)) %>%
  isolateProjectMetadata(project_filter = project_filter) %>%
  relocate(LibID) %>%
  mutate(
    sample_group = paste0(x_axis, " ", group),
    sample_group = if_else(str_detect(sample_group, "Donor FMT"), str_remove(sample_group, " FMT"), sample_group),
    project = "NP"
  )

metadata_MP <- metadata %>%
  filter(LibID %in% colnames(metaphlan)) %>%
  isolateProjectMetadata(project_filter = "MP") %>%
  relocate(LibID) %>%
  mutate(
    sample_group = paste0(x_axis, " ", group),
    sample_group = if_else(str_detect(sample_group, "Donor FMT"), str_remove(sample_group, " FMT"), sample_group),
    project = "MP"
  )

metadata_NP_MP <- bind_rows(metadata_MP, metadata_NP) %>%
  mutate(sample_group = paste0(sample_group, " ", project))
```

```{r}
metaphlan_otu <- metaphlan %>%
  select(-NCBI_tax_id) %>%
  select(clade_name, metadata_NP_MP$LibID) %>%
  mutate(OTU = paste0("OTU", row_number())) %>%
  relocate(OTU)


otutable <- metaphlan_otu %>%
  select(-clade_name)


taxtable <- metaphlan_otu %>%
  select(OTU, clade_name) %>%
  separate(clade_name, sep = "\\|", into = c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")) %>%
  relocate(OTU, .after = "Species")


d <- amp_load(
  otutable = otutable,
  metadata = metadata_NP_MP,
  taxonomy = taxtable
)
```


```{r}
stages <- stages_pre_post

metadata_NP_MP_stages <- metadata_NP_MP %>%
  filter(x_axis %in% stages)

d_subset <- d %>%
  amp_subset_samples(LibID %in% metadata_NP$LibID | x_axis == "Donor", x_axis %in% stages, id != "pt002")
```



```{r}
d_subset %>%
  amp_ordinate(
    type = "pca",
    transform = "hellinger",
    sample_color_by = "sample_group",
    species_plot = T,
    species_nlabels = 7,
    species_label_taxonomy = "Genus",
    sample_shape_by = "x_axis"
  ) +
  geom_line(aes(group = id), color = "grey70") +
  theme(legend.title = element_blank()) +
  scale_color_brewer(palette = "Paired")

# ggsave("../figures/NP_PCA.png", device = "png", width = 6, height = 6)
```

