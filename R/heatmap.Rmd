---
title: "heatmap"
author: "Sebastian MÃ¸lvang Dall"
date: '2022-08-10'
output: html_document
---

## Loading libraries

```{r}
library(tidyverse)
library(ggpubr)
library(mplibrary)
source("./R/functions/metadata_functions.R")
source("./R/functions/gg_functions.R")
```

## Loading Data

**Important!:The MicroPouchNP heatmap is in the bottom. Follow the headers**

```{r}
metadata <- load_metadata()

metaphlan <- load_metaphlan(taxonomic_level = "genus")

project_filter <- "NP"
```

```{r}
metadata_in_metaphlan <- metadata %>%
  filter(LibID %in% colnames(metaphlan))


metaphlan_long <- metaphlan %>%
  select(-NCBI_tax_id) %>%
  pivot_longer(-clade_name, names_to = "LibID") %>%
  arrange(LibID)
```

### Filtering for relevant patients and donors

Just as in alpha_beta_diversity.rmd, the donors are filtered such that only donors used for the available patients are used.

```{r}
stages <- stages_all

metadata_relevant <- isolateProjectMetadata(metadata_in_metaphlan, project_filter = "NP") %>%
  mutate(
    sample_group = paste0(group, "_", x_axis),
    sample_group = if_else(str_detect(sample_group, "FMT_Donor"), str_remove(sample_group, "FMT_"), sample_group)
  ) %>%
  filter(x_axis %in% stages)

n_genera <- 35
```

#### Adding taxonomy to metadata table

```{r}
metadata_relevant_with_tax <- left_join(metadata_relevant, metaphlan_long)
```

## heatmap visualization 
```{r}
metadata_tax_hellinger <- hellingerTransformSamples(metadata_relevant_with_tax)
top_genera_weighted <- calculateTopGenera(metadata_tax_hellinger, n_genera = n_genera)
top_genera_weighted_arranged_by_donor <- arrangeTopGeneraInDonor(metadata_tax_hellinger, top_genera_weighted)
```

```{r}
labels <- c("Pre", paste0("Day ", c(5, 10, 16, 28)), "Post", paste0("Follow-up ", c(1, 3, 6, 12), "M"), paste0("Donor_b", 1:12))
stages_withdonorbatch <- c(grep("Donor", stages, invert = T, value = T), paste0("Donor_b", 1:12))

metadata_tax_hellinger %>%
  filter(clade_name %in% top_genera_weighted$clade_name) %>%
  # group_by(id, x_axis, clade_name) %>%
  # summarise(hellinger = mean(hellinger),
  #           value = mean(value)) %>%
  mutate(
    clade_name = factor(clade_name, levels = top_genera_weighted_arranged_by_donor$clade_name),
    x_axis = if_else(x_axis == "Donor", paste0(x_axis, "_b", fecal_donation_number), x_axis),
    x_axis = factor(x_axis, levels = stages_withdonorbatch, labels = labels),
    value = if_else(value < 10, round(value, 1), floor(value)),
    id = factor(id, levels = c("pt001", "pt002", "pt006", "asym004"))
  ) %>%
  ggplot(aes(x = x_axis, y = fct_rev(clade_name), fill = hellinger, label = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red") +
  geom_text(color = "black") +
  facet_grid(. ~ id, scales = "free_x", space = "free") +
  labs(x = "", y = "") +
  plot_theme +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.35, hjust = 1),
    axis.text = element_text(size = 12)
  )

# ggsave("../figures/NP_heatmap_hellinger_alldonorbatches.png", device = "png", width = 20, height = 10)
```

### Treatment schema

```{r}
donorTreatment <- metadata_relevant %>%
  pivot_longer(batch_1:batch_3, names_to = "batch", values_to = "batch_number") %>%
  filter(!is.na(batch_number)) %>%
  select(id, x_axis, donor, batch, batch_number) %>%
  mutate(
    batch = str_replace(batch, "_", " "),
    x_axis = factor(x_axis, levels = stages_withdonorbatch, labels = labels)
  )


donorTreatment %>%
  ggplot(aes(x = batch, y = id, label = batch_number, group = id)) +
  geom_line() +
  geom_point(size = 10, color = "lightblue") +
  geom_text() +
  facet_grid(. ~ x_axis, scales = "free_x") +
  plot_theme +
  labs(y = "") +
  theme(panel.grid.major.x = element_blank())

ggsave("../figures/NP_donorbatch_treatment.png", device = "png")
```




